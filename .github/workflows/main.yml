import os
import subprocess
import sys
import winreg
import secrets
import string
import requests

def is_admin():
    """التحقق مما إذا كان السكربت يعمل بصلاحيات المسؤول"""
    try:
        return os.getuid() == 0
    except AttributeError:
        import ctypes
        return ctypes.windll.shell32.IsUserAnAdmin() != 0

def set_registry_key(path, name, value):
    """تعديل قيم الريجستري لإعدادات RDP"""
    try:
        key = winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, path, 0, winreg.KEY_SET_VALUE)
        winreg.SetValueEx(key, name, 0, winreg.REG_DWORD, value)
        winreg.CloseKey(key)
        print(f"[+] تم تحديث الريجستري: {name} = {value}")
    except Exception as e:
        print(f"[-] خطأ في تحديث الريجستري: {e}")

def configure_rdp():
    """إعدادات RDP الأساسية والجدار الناري"""
    print("[*] جاري إعداد RDP...")
    # تمكين RDP وتعطيل NLA (Network Level Authentication) للتبسيط
    path = r"System\CurrentControlSet\Control\Terminal Server"
    set_registry_key(path, "fDenyTSConnections", 0)
    
    path_tcp = r"System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp"
    set_registry_key(path_tcp, "UserAuthentication", 0)
    set_registry_key(path_tcp, "SecurityLayer", 0)

    # إعداد الجدار الناري (Firewall)
    subprocess.run(['netsh', 'advfirewall', 'firewall', 'delete', 'rule', 'name=RDP-Python'], capture_output=True)
    subprocess.run(['netsh', 'advfirewall', 'firewall', 'add', 'rule', 'name=RDP-Python', 
                    'dir=in', 'action=allow', 'protocol=TCP', 'localport=3389'], check=True)
    print("[+] تم فتح المنفذ 3389 في الجدار الناري.")

def generate_password(length=16):
    """توليد كلمة مرور قوية وعشوائية"""
    alphabet = string.ascii_letters + string.digits + "!@#$%^&*"
    return ''.join(secrets.choice(alphabet) for i in range(length))

def create_rdp_user(username, password):
    """إنشاء مستخدم جديد وإضافته لمجموعات المسؤولين و RDP"""
    try:
        # إنشاء المستخدم
        subprocess.run(['net', 'user', username, password, '/add', '/expires:never'], check=True)
        # إضافة للمسؤولين
        subprocess.run(['net', 'localgroup', 'Administrators', username, '/add'], check=True)
        # إضافة لمستخدمي سطح المكتب البعيد
        subprocess.run(['net', 'localgroup', 'Remote Desktop Users', username, '/add'], check=True)
        print(f"[+] تم إنشاء المستخدم: {username}")
        print(f"[!] كلمة المرور: {password}")
    except Exception as e:
        print(f"[-] فشل إنشاء المستخدم: {e}")

def install_tailscale(auth_key=None):
    """تحميل وتثبيت Tailscale والاتصال به"""
    url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
    installer = os.path.join(os.environ['TEMP'], "tailscale.msi")
    
    print("[*] جاري تحميل Tailscale...")
    response = requests.get(url)
    with open(installer, 'wb') as f:
        f.write(response.content)
    
    print("[*] جاري التثبيت الصامت...")
    subprocess.run(['msiexec.exe', '/i', installer, '/quiet', '/norestart'], check=True)
    
    if auth_key:
        print("[*] جاري الاتصال بـ Tailscale...")
        ts_path = os.path.join(os.environ['ProgramFiles'], "Tailscale", "tailscale.exe")
        subprocess.run([ts_path, 'up', '--authkey=' + auth_key], check=True)

if __name__ == "__main__":
    if not is_admin():
        print("[-] يرجى تشغيل السكربت كمسؤول (Run as Administrator)!")
        sys.exit(1)

    # تنفيذ العمليات
    configure_rdp()
    
    user = "RDP_User"
    pwd = generate_password()
    create_rdp_user(user, pwd)
    
    # اختياري: تثبيت Tailscale إذا أردت (يتطلب مفتاح Auth Key)
    # install_tailscale(auth_key="YOUR_KEY_HERE")

    print("\n" + "="*30)
    print("✅ اكتمل الإعداد بنجاح!")
    print(f"اسم المستخدم: {user}")
    print(f"كلمة المرور: {pwd}")
    print("="*30)
